#
# A couple of useful guides & docs:
#
# - Main Bitrise CLI docs: https://github.com/bitrise-io/bitrise/tree/master/_docs
# - Step Development Guideline: https://github.com/bitrise-io/bitrise/blob/master/_docs/step-development-guideline.md
# - Bitrise.yml format spec: https://github.com/bitrise-io/bitrise/blob/master/_docs/bitrise-yml-format-spec.md
# - Bitrise docs: http://devcenter.bitrise.io/
# - Bitrise CLI guides: http://devcenter.bitrise.io/bitrise-cli/

title: |-
  bitrise-step-jira-ticket-transition
summary: |
  Move tickets in Jira
description: |
  Move multiple tickets to a chain of allowed transitions
website: https://github.com/Freebox-Apps/bitrise-step-jira-ticket-transition
source_code_url: https://github.com/Freebox-Apps/bitrise-step-jira-ticket-transition
support_url: https://github.com/Freebox-Apps/bitrise-step-jira-ticket-transition

type_tags:
  - utility

deps:
  brew:
  - name: git
  - name: wget
  apt_get:
  - name: git
  - name: wget

toolkit:
  go:
    package_name: github.com/Freebox-CI/bitrise-step-jira-ticket-transition

inputs:
  - JIRA_DOMAIN:
    opts:
      title: Jira company DOMAIN
      description:  e.g. `https://mycompany.atlassian.net`
      is_sensitive: true
      is_required: true
  - JIRA_USER:
    opts:
      title: Jira user name
      description: User name on Jira (user's email).
      is_sensitive: true
      is_required: true
  - JIRA_TOKEN:
    opts:
      title: Jira token
      description: API token generated on Jira at <https://id.atlassian.com/manage-profile/security/api-tokens>
      is_required: true
      is_sensitive: true
  - TICKET_LIST:
    opts:
      title: Ticket list
      description: |
        All tickets to apply transition
      is_required: true
  - TICKET_DELIMITER: "|"
    opts:
      title: Ticket delimiter
      description: Delimiter to use when several tickets are found e.g. with `|` will ouptut TK-123|TK-124
      is_required: true
  - TRANSITION_LIST:
    opts:
      title: Json map of issue types and transition list to move to
      description: |
        Enter an issue type and the transition list IDs map to apply to your ticket list. e.g. `{ "issueTypeId": ["transitionId1", "transitionId2"] }`

        **Issue type IDs** can be found in project settings page `https://JIRA_COMPANY_DOMAIN/jira/software/projects/PROJECT_PREFIX/settings/issuetypes`
        Select one and look at the id at the end. NB: you need admin rights to access this page.

        **Transition IDs** for a given ticket can be found with:

        ```
        curl -s -u "$EMAIL:$API_TOKEN" \
        -H "Accept: application/json" \
        "https://$DOMAIN/rest/api/3/issue/$ISSUE_KEY/transitions"|
        jq -r '.transitions[] | "\(.id)\t\(.name)"'
        ```

        **Example** input would look like the following:
          ```
          {
              "10019": ["71", "111"],
              "10020": ["71", "111"],
              "10021": ["71", "111"],
              "10057": ["71", "111"],
              "10048": ["71", "15"],
              "10982": ["71", "15"],
              "10983": ["71", "15"]
            }
          ```
      is_required: true
